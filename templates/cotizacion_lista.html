{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Cotizaciones{% endblock %}

{% block content %}
<main>
    <div class="container-fluid px-4">
        <h1 class="mt-4">Cotizaciones</h1>
        <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Inicio</a></li>
            <li class="breadcrumb-item active">Cotizaciones</li>
        </ol>

        <div class="card mb-4 shadow-sm border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-invoice me-1"></i> Nueva Cotización</span>
                <span class="badge bg-white text-primary fs-6" id="total-cotizacion-badge">Total: $0.00</span>
            </div>
            <div class="card-body">
                <form method="POST" action="{% url 'cotizaciones' %}" id="form-cotizacion">
                    {% csrf_token %}
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Cliente</label>
                            <div class="input-group">
                                {{ form.cliente }} <button class="btn btn-outline-secondary" type="button" onclick="alert('Aquí podrías abrir el modal de crear cliente')">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold">Fecha Vencimiento</label>
                            {{ form.fecha_vencimiento }}
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Términos y Condiciones</label>
                            {{ form.terminos_y_condiciones }}
                        </div>
                    </div>

                    <div class="table-responsive mb-3" style="background-color: #f8f9fa; border-radius: 5px;">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr class="text-center small text-uppercase">
                                    <th style="width: 40%;">Producto</th>
                                    <th style="width: 10%;">Cant.</th>
                                    <th style="width: 15%;">Precio Unit.</th>
                                    <th style="width: 10%;">Desc. ($)</th>
                                    <th style="width: 15%;">Subtotal</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="detalle-formset">
                                {{ formset.management_form }}
                                {% for f in formset %}
                                    <tr class="detalle-row">
                                        {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
                                        <td class="p-1">{{ f.producto }}</td>
                                        <td class="p-1">{{ f.cantidad }}</td>
                                        <td class="p-1">{{ f.precio_unitario }}</td>
                                        <td class="p-1">{{ f.descuento }}</td>
                                        <td class="p-1">
                                            <input type="text" class="form-control form-control-sm text-end fw-bold subtotal-input" readonly value="0.00">
                                        </td>
                                        <td class="p-1 text-center">
                                            <button type="button" class="btn btn-outline-danger btn-xs delete-row border-0"><i class="fas fa-times"></i></button>
                                            <div class="d-none">{{ f.DELETE }}</div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" id="add-row" class="btn btn-success btn-sm">
                            <i class="fas fa-plus-circle me-1"></i> Agregar Producto
                        </button>
                        <button type="submit" class="btn btn-primary fw-bold">
                            <i class="fas fa-save me-1"></i> Guardar Cotización
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-table me-1"></i> Historial de Cotizaciones
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="datatablesSimple" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th># Cotización</th>
                                <th>Cliente</th>
                                <th>Fecha Emisión</th>
                                <th>Fecha Vencimiento</th>
                                <th>Estado</th>
                                <th class="text-end">Importe Total</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cotizacion in cotizaciones %}
                            <tr>
                                <td>{{ cotizacion.id|stringformat:"06d" }}</td> <td>{{ cotizacion.cliente.nombre }}</td>
                                <td>{{ cotizacion.fecha_emision|date:"d/m/Y" }}</td>
                                <td>{{ cotizacion.fecha_vencimiento|date:"d/m/Y" }}</td>
                                <td>
                                    {% if cotizacion.estado == 'A' %}<span class="badge bg-success">Aceptada</span>
                                    {% elif cotizacion.estado == 'F' %}<span class="badge bg-info">Facturada</span>
                                    {% elif cotizacion.estado == 'E' %}<span class="badge bg-primary">Enviada</span>
                                    {% elif cotizacion.estado == 'R' %}<span class="badge bg-danger">Rechazada</span>
                                    {% else %}<span class="badge bg-secondary">Borrador</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">${{ cotizacion.total|floatformat:2 }}</td>
                                <td class="text-center">
                                    <a href="#" class="btn btn-outline-primary btn-sm" title="Ver Detalle">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">No hay cotizaciones registradas.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<table style="display: none;">
    <tbody id="empty-form">
        <tr class="detalle-row">
            <td class="p-1">{{ formset.empty_form.producto }}</td>
            <td class="p-1">{{ formset.empty_form.cantidad }}</td>
            <td class="p-1">{{ formset.empty_form.precio_unitario }}</td>
            <td class="p-1">{{ formset.empty_form.descuento }}</td>
            <td class="p-1"><input type="text" class="form-control form-control-sm text-end fw-bold subtotal-input" readonly value="0.00"></td>
            <td class="p-1 text-center">
                <button type="button" class="btn btn-outline-danger btn-xs delete-row border-0"><i class="fas fa-times"></i></button>
                <div class="d-none">{{ formset.empty_form.DELETE }}</div>
            </td>
        </tr>
    </tbody>
</table>

{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. CONFIGURACIÓN INICIAL ---
        const formsetContainer = document.getElementById('detalle-formset');
        const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
        const urlBuscarProductos = "{% url 'buscar_productos_ajax' %}"; 
        const urlBuscarClientes = "{% url 'buscar_clientes_ajax' %}";

        // --- 2. FUNCIONES DE CÁLCULO ---
        function calculateRow(row) {
            const cant = parseFloat(row.querySelector('.cantidad').value) || 0;
            const precio = parseFloat(row.querySelector('.precio-unitario').value) || 0;
            const desc = parseFloat(row.querySelector('.descuento').value) || 0;
            
            // Fórmula: (Cantidad * Precio) - Descuento
            let subtotal = (cant * precio) - desc;
            if(subtotal < 0) subtotal = 0;

            row.querySelector('.subtotal-input').value = subtotal.toFixed(2);
            updateTotalGlobal();
        }

        function updateTotalGlobal() {
            let total = 0;
            document.querySelectorAll('.detalle-row').forEach(row => {
                if (row.style.display !== 'none') {
                    total += parseFloat(row.querySelector('.subtotal-input').value) || 0;
                }
            });
            document.getElementById('total-cotizacion-badge').textContent = 'Total: $' + total.toFixed(2);
        }

        // --- 3. INICIALIZAR SELECT2 (AJAX) ---
        // Para Clientes
        $('#id_cliente').select2({
            theme: "bootstrap-5", width: '100%', placeholder: 'Buscar Cliente...',
            ajax: { url: urlBuscarClientes, dataType: 'json', delay: 250, data: p => ({ q: p.term }), processResults: d => ({ results: d.results }) }
        });

        // Para Productos (Función reutilizable)
        function initProductSelect(element) {
            $(element).select2({
                theme: "bootstrap-5", width: '100%', placeholder: 'Buscar Producto...',
                ajax: { url: urlBuscarProductos, dataType: 'json', delay: 250, data: p => ({ q: p.term }), processResults: d => ({ results: d.results }) }
            });

            // Al seleccionar producto, traer precio (Si tu backend lo envía)
            $(element).on('select2:select', function(e) {
                const data = e.params.data;
                const row = this.closest('tr');
                // Asumiendo que tu AJAX de productos devuelve 'precio' en el JSON
                if(data.precio) {
                    row.querySelector('.precio-unitario').value = data.precio;
                }
                row.querySelector('.cantidad').value = 1;
                calculateRow(row);
            });
        }

        // Inicializar los existentes
        $('.producto-select').each(function() { initProductSelect(this); });

        // --- 4. AGREGAR FILAS ---
        document.getElementById('add-row').addEventListener('click', function() {
            const formCount = parseInt(totalFormsInput.value);
            const emptyHtml = document.getElementById('empty-form').innerHTML.replace(/__prefix__/g, formCount);
            formsetContainer.insertAdjacentHTML('beforeend', emptyHtml);
            
            // Inicializar Select2 en la nueva fila
            const newRow = formsetContainer.lastElementChild;
            initProductSelect(newRow.querySelector('.producto-select'));
            
            totalFormsInput.value = formCount + 1;
        });

        // --- 5. EVENTOS DINÁMICOS (Cálculos y Borrar) ---
        formsetContainer.addEventListener('input', function(e) {
            if (e.target.matches('.cantidad, .precio-unitario, .descuento')) {
                calculateRow(e.target.closest('tr'));
            }
        });

        formsetContainer.addEventListener('click', function(e) {
            if (e.target.closest('.delete-row')) {
                const row = e.target.closest('tr');
                const deleteInput = row.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.style.display = 'none';
                } else {
                    row.remove();
                }
                updateTotalGlobal();
            }
        });
    });
</script>
{% endblock %}