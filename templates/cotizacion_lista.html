{% extends 'base.html' %}
{% load static %}

{% block title %}Cotizaciones{% endblock %}

{% block content %}
<main>
    <div class="container-fluid px-4">
        
        <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
            <h1 class="h3 mb-0 text-gray-800">Cotizaciones</h1>
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item active">Cotizaciones</li>
            </ol>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <span class="fw-bold"><i class="fas fa-file-signature me-1"></i> Nueva Cotización</span>
                <div>
                    <span class="badge bg-dark me-2" id="total-header" style="font-size: 0.9rem;">Total: $0.00</span>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseForm">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            
            <div class="collapse show" id="collapseForm">
                <div class="card-body">
                    <form method="POST" action="{% url 'cotizaciones' %}" id="formCotizacion">
                        {% csrf_token %}
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-5">
                                <label class="form-label small fw-bold text-secondary">CLIENTE</label>
                                <div class="input-group input-group-sm">
                                    {{ cotizacion_form.cliente }}
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalCliente">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-secondary">VALIDEZ</label>
                                {{ cotizacion_form.fecha_vencimiento }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-secondary">NOTAS</label>
                                <input type="text" name="notas" class="form-control form-control-sm" placeholder="Condiciones de pago, entrega...">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40%;">Producto</th>
                                        <th style="width: 10%;" class="text-center">Cant.</th>
                                        <th style="width: 15%;" class="text-end">Precio ($)</th>
                                        <th style="width: 15%;" class="text-end">Total ($)</th>
                                        <th style="width: 5%;"></th>
                                    </tr>
                                </thead>
                                <tbody id="detalle-formset">
                                    {{ detalle_formset.management_form }}
                                    {% for form in detalle_formset %}
                                    <tr class="detalle-form">
                                        {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                        <td class="p-1">{{ form.producto }}</td>
                                        <td class="p-1">{{ form.cantidad }}</td>
                                        <td class="p-1">{{ form.precio_unitario }}</td>
                                        <td class="p-1"><input type="text" class="form-control form-control-sm text-end fw-bold subtotal-input" readonly value="0.00" style="background-color: #f8f9fa;"></td>
                                        <td class="p-1 text-center">
                                            <button type="button" class="btn btn-link text-danger btn-sm delete-row p-0"><i class="fas fa-times"></i></button>
                                            <div class="d-none">{{ form.DELETE }}</div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" id="add-row" class="btn btn-light btn-sm border text-primary fw-bold">
                                <i class="fas fa-plus-circle me-1"></i> Agregar Producto
                            </button>
                        </div>

                        <hr class="my-3">

                        <div class="d-flex justify-content-end gap-2">
                            <button type="reset" class="btn btn-outline-secondary btn-sm px-3">Limpiar</button>
                            <button type="submit" class="btn btn-primary btn-sm px-4 fw-bold">
                                <i class="fas fa-save me-1"></i> Guardar Cotización
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <i class="fas fa-list me-1"></i> Historial
            </div>
            <div class="card-body">
                <table id="datatablesSimple" class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in cotizaciones %}
                        <tr>
                            <td>{{ c.id|stringformat:"05d" }}</td>
                            <td>{{ c.cliente.nombre }}</td>
                            <td>{{ c.fecha_emision|date:"d/m/Y" }}</td>
                            <td>${{ c.total|floatformat:2 }}</td>
                            <td><span class="badge bg-secondary">{{ c.estado }}</span></td>
                            <td>
                                <a href="#" class="btn btn-outline-dark btn-sm border-0 py-0"><i class="fas fa-print"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<table style="display: none;">
    <tbody id="empty-form-template">
        <tr class="detalle-form">
            <td class="p-1">{{ detalle_formset.empty_form.producto }}</td>
            <td class="p-1">{{ detalle_formset.empty_form.cantidad }}</td>
            <td class="p-1">{{ detalle_formset.empty_form.precio_unitario }}</td>
            <td class="p-1"><input type="text" class="form-control form-control-sm text-end fw-bold subtotal-input" readonly value="0.00" style="background-color: #f8f9fa;"></td>
            <td class="p-1 text-center">
                <button type="button" class="btn btn-link text-danger btn-sm delete-row p-0"><i class="fas fa-times"></i></button>
                <div class="d-none">{{ detalle_formset.empty_form.DELETE }}</div>
            </td>
        </tr>
    </tbody>
</table>

{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlBuscarProductos = "{% url 'buscar_productos_venta_ajax' %}";
    
    // ==========================================
    // 1. SOLUCIÓN BUG "DOBLE FILA"
    // ==========================================
    const addBtn = document.getElementById('add-row');
    const formsetContainer = document.getElementById('detalle-formset');
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const emptyFormTemplate = document.getElementById('empty-form-template');

    // Removemos cualquier listener previo por seguridad (buena práctica)
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);

    newAddBtn.addEventListener('click', function(e) {
        e.preventDefault(); // Evita cualquier comportamiento nativo o submit accidental
        e.stopPropagation(); // Evita que el click "suba" al formulario

        // 1. Obtener índice actual
        let formIdx = parseInt(totalFormsInput.value);
        
        // 2. Clonar el template y reemplazar __prefix__
        // Usamos innerHTML para obtener el texto y reemplazar
        let newRowHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIdx);
        
        // 3. Insertar SOLO UNA VEZ
        formsetContainer.insertAdjacentHTML('beforeend', newRowHtml);

        // 4. Actualizar contador
        totalFormsInput.value = formIdx + 1;

        // 5. Inicializar Select2 en la nueva fila
        const newRow = formsetContainer.lastElementChild; // Obtenemos el elemento DOM real
        const select = newRow.querySelector('select');
        if(select) initProductSelect(select);
    });

    // ==========================================
    // 2. LÓGICA DE PRODUCTOS Y CÁLCULOS
    // ==========================================
    function initProductSelect(element) {
        $(element).select2({
            theme: "bootstrap-5", width: '100%', placeholder: 'Buscar...',
            ajax: {
                url: urlBuscarProductos, dataType: 'json', delay: 250,
                data: params => ({ q: params.term }),
                processResults: data => ({ results: data.results })
            }
        }).on('select2:select', function(e) {
            const data = e.params.data;
            const row = this.closest('tr');
            if(data.precio) row.querySelector('input[name$="precio_unitario"]').value = data.precio;
            row.querySelector('input[name$="cantidad"]').value = 1;
            calculateRow(row);
        });
    }

    // Inicializar filas existentes
    $('#detalle-formset select').each(function() { initProductSelect(this); });

    // Cálculos
    function calculateRow(row) {
        const cant = parseFloat(row.querySelector('input[name$="cantidad"]').value) || 0;
        const precio = parseFloat(row.querySelector('input[name$="precio_unitario"]').value) || 0;
        row.querySelector('.subtotal-input').value = (cant * precio).toFixed(2);
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.detalle-form').forEach(row => {
            if(row.style.display !== 'none') {
                total += parseFloat(row.querySelector('.subtotal-input').value) || 0;
            }
        });
        document.getElementById('total-header').textContent = 'Total: $' + total.toFixed(2);
    }

    // Eventos delegados para inputs (cálculo en tiempo real)
    formsetContainer.addEventListener('input', function(e) {
        if(e.target.matches('input[name$="cantidad"], input[name$="precio_unitario"]')) {
            calculateRow(e.target.closest('tr'));
        }
    });

    // Eliminar fila
    formsetContainer.addEventListener('click', function(e) {
        if (e.target.closest('.delete-row')) {
            e.preventDefault();
            const row = e.target.closest('tr');
            const delInput = row.querySelector('input[name$="-DELETE"]');
            if(delInput) { 
                delInput.checked = true; 
                row.style.display = 'none'; 
                row.querySelector('.subtotal-input').value = 0; // Para que el total se recalcule bien
            } else { 
                row.remove(); 
            }
            updateTotal();
        }
    });

    // Inicializar Select2 Cliente
    $('#{{ cotizacion_form.cliente.id_for_label }}').select2({
        theme: "bootstrap-5", width: '100%', placeholder: 'Buscar cliente...'
        // ... (tu configuración ajax de clientes)
    });
});
</script>
{% endblock %}