{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle de Cotización{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Detalle de Cotización #{{ cotizacion.id }}</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Inicio</a></li>
        <li class="breadcrumb-item"><a href="{% url 'cotizaciones' %}">Cotizaciones</a></li>
        <li class="breadcrumb-item active">Detalle</li>
    </ol>

    <div class="d-flex justify-content-end mb-3">
    
        {% if cotizacion.estado == 'A' %}
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#convertirModal">
            <i class="fas fa-file-invoice-dollar me-1"></i> Convertir a Factura
        </button>
        {% endif %}

        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="accionesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Acciones
            </button>
            <ul class="dropdown-menu" aria-labelledby="accionesDropdown">
                {% if cotizacion.estado == 'B' %}
                    <li><a class="dropdown-item btn-cambiar-estado" href="#" data-nuevo-estado="E">Marcar como Enviada</a></li>
                {% elif cotizacion.estado == 'E' %}
                    <li><a class="dropdown-item btn-cambiar-estado" href="#" data-nuevo-estado="A">Marcar como Aceptada</a></li>
                    <li><a class="dropdown-item btn-cambiar-estado" href="#" data-nuevo-estado="R">Marcar como Rechazada</a></li>
                {% endif %}
                
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'cotizacion_pdf' cotizacion.id %}" target="_blank">Imprimir PDF</a></li>
                
            </ul>
        </div>

    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header"><i class="fas fa-receipt me-1"></i>Detalles de la Cotización</div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th>Cliente:</th>
                            <td>{{ cotizacion.cliente.nombre }} ({{ cotizacion.cliente.ruc }})</td>
                        </tr>
                        <tr>
                            <th>Fecha Emisión:</th>
                            <td>{{ cotizacion.fecha_emision|date:"d/m/Y" }}</td>
                        </tr>
                        <tr>
                            <th>Válida Hasta:</th>
                            <td>{{ cotizacion.fecha_vencimiento|date:"d/m/Y" }}</td>
                        </tr>
                        <tr>
                            <th>Estado:</th>
                            <td>
                                {% if cotizacion.estado == 'A' %}<span class="badge bg-success">{{ cotizacion.get_estado_display }}</span>
                                {% elif cotizacion.estado == 'F' %}<span class="badge bg-info">{{ cotizacion.get_estado_display }}</span>
                                {% else %}<span class="badge bg-secondary">{{ cotizacion.get_estado_display }}</span>
                                {% endif %}
                            </td>
                        </tr>
                         {% if cotizacion.factura_generada %}
                        <tr>
                            <th>Factura Asociada:</th>
                            <td>
                                <a href="#">Factura #{{ cotizacion.factura_generada.id }}</a>
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td colspan="2">
                                <strong>Términos y Condiciones:</strong><br>
                                {{ cotizacion.terminos_y_condiciones|linebreaksbr }}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header"><i class="fas fa-calculator me-1"></i>Resumen de Totales</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <strong>${{ cotizacion.total_sin_impuestos|floatformat:2 }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Descuento:</span>
                            <strong>-${{ cotizacion.total_descuento|floatformat:2 }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>IVA ({{ iva_porcentaje|floatformat:0 }}%):</span>
                            <strong>${{ iva_calculado|floatformat:2 }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between bg-light">
                            <h4>Total:</h4>
                            <h4>${{ cotizacion.importe_total|floatformat:2 }}</h4>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><i class="fas fa-list-ol me-1"></i>Productos y Servicios</div>
        <div class="card-body">
            <table class="table">
                <thead class="table-light">
                    <tr>
                        <th>Producto</th>
                        <th class="text-end">Cantidad</th>
                        <th class="text-end">P. Unitario</th>
                        <th class="text-end">Descuento</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detalle in cotizacion.detalles.all %}
                    <tr>
                        <td>{{ detalle.producto.nombre }}</td>
                        <td class="text-end">{{ detalle.cantidad|floatformat:2 }}</td>
                        <td class="text-end">${{ detalle.precio_unitario|floatformat:2 }}</td>
                        <td class="text-end">${{ detalle.descuento|floatformat:2 }}</td>
                        <td class="text-end">${{ detalle.precio_total_sin_impuesto|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="convertirModal" tabindex="-1" aria-labelledby="convertirModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="convertirModalLabel">Confirmar Facturación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Estás a punto de generar una factura a partir de esta cotización. Por favor, selecciona el punto de venta desde donde se emitirá.</p>
                <div class="mb-3">
                    <label for="puntoVentaSelect" class="form-label">Punto de Venta:</label>
                    <select id="puntoVentaSelect" class="form-select">
                        {% for pv in puntos_venta %}
                        <option value="{{ pv.id }}">{{ pv }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="convertirAFactura({{ cotizacion.id }})">Confirmar y Facturar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
function convertirAFactura(cotizacionId) {
    const puntoVentaId = $('#puntoVentaSelect').val();
    if (!puntoVentaId) {
        alert('Por favor, seleccione un punto de venta.');
        return;
    }

    // Opcional: Deshabilitar el botón para evitar doble clic
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

    $.ajax({
        url: "{% url 'ajax_convertir_cotizacion' %}",
        method: 'POST',
        data: {
            'cotizacion_id': cotizacionId,
            'punto_venta_id': puntoVentaId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.status === 'ok') {
                Swal.fire({
                    title: '¡Éxito!',
                    text: response.message,
                    icon: 'success',
                    confirmButtonText: 'Aceptar'
                }).then(() => {
                    // Recargar la página para mostrar el nuevo estado
                    window.location.reload(); 
                });
            } else {
                Swal.fire('Error', response.message, 'error');
            }
        },
        error: function() {
            Swal.fire('Error', 'Ocurrió un error de conexión.', 'error');
        },
        complete: function() {
            // Volver a habilitar el botón
            btn.disabled = false;
            btn.innerHTML = 'Confirmar y Facturar';
            $('#convertirModal').modal('hide');
        }
    });
}
$(document).ready(function() {
        $('.dropdown').on('click', '.btn-cambiar-estado', function(e) {
            e.preventDefault(); // Evitar que el enlace navegue

            const nuevoEstado = $(this).data('nuevo-estado');
            const cotizacionId = {{ cotizacion.id }};
            const nuevoEstadoTexto = $(this).text();

            Swal.fire({
                title: '¿Estás seguro?',
                text: `Se cambiará el estado de la cotización a "${nuevoEstadoTexto}".`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cambiar estado',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "{% url 'ajax_cambiar_estado_cotizacion' %}",
                        method: 'POST',
                        data: {
                            'cotizacion_id': cotizacionId,
                            'nuevo_estado': nuevoEstado,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            if (response.status === 'ok') {
                                Swal.fire('¡Actualizado!', response.message, 'success').then(() => {
                                    window.location.reload(); // Recargar para ver los cambios
                                });
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                        },
                        error: function() {
                            Swal.fire('Error', 'Ocurrió un error de conexión.', 'error');
                        }
                    });
                }
            });
        });
        });
</script>
{% endblock %}